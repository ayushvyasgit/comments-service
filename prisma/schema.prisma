generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  subdomain String   @unique
  apiKey    String   @unique
  plan      Plan     @default(FREE)
  status    TenantStatus @default(ACTIVE)
  
  rateLimitPerMinute Int @default(100) @map("rate_limit_per_minute")
  rateLimitPerHour   Int @default(1000) @map("rate_limit_per_hour")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  comments  Comment[]
  likes     Like[]
  auditLogs AuditLog[]
  
  @@map("tenants")
}

enum Plan {
  FREE
  STARTER
  BUSINESS
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model Comment {
  id          String   @id @default(uuid()) @db.Uuid
  
  tenantId    String   @map("tenant_id") @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  entityId    String   @map("entity_id")
  
  parentId    String?  @map("parent_id") @db.Uuid
  parent      Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")
  
  depth       Int      @default(0)
  path        String   @default("")
  
  authorId    String   @map("author_id")
  authorName  String   @map("author_name")
  authorEmail String?  @map("author_email")
  
  content     String   @db.Text
  
  status      CommentStatus @default(ACTIVE)
  
  likeCount   Int      @default(0) @map("like_count")
  replyCount  Int      @default(0) @map("reply_count")
  
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  likes       Like[]
  
  @@index([tenantId, entityId, createdAt])
  @@index([tenantId, parentId])
  @@index([tenantId, status])
  @@map("comments")
}

enum CommentStatus {
  ACTIVE
  DELETED
  FLAGGED
  SPAM
}

model Like {
  id        String   @id @default(uuid()) @db.Uuid
  
  tenantId  String   @map("tenant_id") @db.Uuid
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  commentId String   @map("comment_id") @db.Uuid
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  userId    String   @map("user_id")
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@unique([tenantId, commentId, userId])
  @@index([tenantId, commentId])
  @@index([userId])
  @@map("likes")
}

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  
  tenantId    String   @map("tenant_id") @db.Uuid
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  action      AuditAction
  resource    String
  resourceId  String?  @map("resource_id")
  
  userId      String?  @map("user_id")
  userName    String?  @map("user_name")
  
  method      String?
  path        String?
  
  metadata    Json     @default("{}")
  
  success     Boolean  @default(true)
  errorMessage String? @map("error_message")
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([tenantId, action, createdAt])
  @@index([tenantId, resource, createdAt])
  @@index([tenantId, userId, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditAction {
  COMMENT_CREATED
  COMMENT_UPDATED
  COMMENT_DELETED
  COMMENT_VIEWED
  COMMENT_LIKED
  COMMENT_UNLIKED
  TENANT_CREATED
  TENANT_UPDATED
  AUTH_SUCCESS
  AUTH_FAILED
  RATE_LIMIT_EXCEEDED
}